!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs/operators"),require("rxjs"),require("@angular/common"),require("@angular/common/http"),require("@angular/router"),require("@sofico-framework/app-config"),require("@sofico-framework/utils"),require("angular-oauth2-oidc"),require("angular-oauth2-oidc-jwks")):"function"==typeof define&&define.amd?define("@sofico-framework/authentication",["exports","@angular/core","rxjs/operators","rxjs","@angular/common","@angular/common/http","@angular/router","@sofico-framework/app-config","@sofico-framework/utils","angular-oauth2-oidc","angular-oauth2-oidc-jwks"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self)["sofico-framework"]=e["sofico-framework"]||{},e["sofico-framework"].authentication={}),e.ng.core,e.rxjs.operators,e.rxjs,e.ng.common,e.ng.common.http,e.ng.router,e.appConfig,e.utils,e.angularOauth2Oidc,e.angularOauth2OidcJwks)}(this,(function(e,t,r,i,o,n,a,c,u,s,h){"use strict";var l=function(){function e(){this._authenticatedResult$=new i.ReplaySubject(1)}return Object.defineProperty(e.prototype,"authenticatedResult$",{get:function(){return this._authenticatedResult$.asObservable().pipe(r.distinctUntilChanged())},enumerable:!1,configurable:!0}),e.prototype.setAuthenticatedResult=function(e){this._authenticatedResult$.next(e)},e}();l.decorators=[{type:t.Injectable}];var p=function(){function e(e,t,r,i,o,n,a){if(this.httpClient=e,this.windowRefService=t,this.oauthService=r,this.router=i,this.configService=o,this.authenticatedResultService=n,this.platformLocation=a,this.location=this.windowRefService.nativeWindow.location,this.baseHref=this.location.origin+this.platformLocation.getBaseHrefFromDOM(),"implicit"!==this.configService.config.auth.grant)throw new Error("unsupported authentication grant");this.configureLoginWithSSO(),this.listenOnErrorReceivedAndLogout()}return e.prototype.loginWithSingleSignOn=function(){this.oauthService.initImplicitFlow()},e.prototype.logout=function(e){void 0===e&&(e=!1),this.oauthService.redirectUri=this.calculateRedirectUri(e),this.oauthService.logOut()},e.prototype.logoutWithoutRedirect=function(){this.oauthService.logOut(!0)},e.prototype.setPostLogoutRedirectUri=function(e){this.oauthService.postLogoutRedirectUri=e},e.prototype.configureLoginWithSSO=function(){var e=this,t=this.getLanguageParam(),r={clientId:this.configService.config.auth.clientId,issuer:this.calculateIssuer(this.configService.config),redirectUri:this.calculateRedirectUri(!0),silentRefreshRedirectUri:this.baseHref+"silent-refresh.html",postLogoutRedirectUri:this.baseHref};this.oauthService.configure(r),t&&(this.oauthService.customQueryParams={kc_locale:t}),this.oauthService.tokenValidationHandler=new h.JwksValidationHandler,this.oauthService.loadDiscoveryDocumentAndTryLogin().then((function(){return e.authenticatedResultService.setAuthenticatedResult(e.oauthService.hasValidIdToken())})).catch((function(){return e.authenticatedResultService.setAuthenticatedResult(!1)})),this.oauthService.setupAutomaticSilentRefresh()},e.prototype.calculateRedirectUri=function(e){var t=this.location,r=t.protocol,i=t.host,o=t.pathname,n=t.search;return r+"//"+i+(e?o+n:"")},e.prototype.calculateIssuer=function(e){return e.auth.baseUrl+e.auth.realm},e.prototype.listenOnErrorReceivedAndLogout=function(){var e=this;this.oauthService.events.pipe(r.filter((function(e){return"silent_refresh_error"===e.type||"token_error"===e.type})),r.take(1)).subscribe((function(){return e.logout(!0)}))},e.prototype.getLanguageParam=function(){var e=this.windowRefService.nativeWindow.location.search;return new URLSearchParams(e).get("ui_locales")},e}();p.decorators=[{type:t.Injectable}],p.ctorParameters=function(){return[{type:n.HttpClient},{type:u.WindowRefService},{type:s.OAuthService},{type:a.Router},{type:c.ConfigService},{type:l},{type:o.PlatformLocation}]};var f=function(){function e(e,t){this.authenticationService=e,this.authenticatedResultService=t}return e.prototype.canActivate=function(){var e=this;return this.authenticatedResultService.authenticatedResult$.pipe(r.tap((function(t){t||e.authenticationService.loginWithSingleSignOn()})))},e}();f.decorators=[{type:t.Injectable}],f.ctorParameters=function(){return[{type:p},{type:l}]};var d=function(){function e(e,t,r,i){this.authenticationService=e,this.authenticatedResultService=t,this.configService=r,this.router=i}return e.prototype.canActivate=function(){var e=this;return this.authenticatedResultService.authenticatedResult$.pipe(r.map((function(t){return t?(e.router.navigate(["/"]),!1):"implicit"===e.configService.config.auth.grant?(e.authenticationService.loginWithSingleSignOn(),!1):!t})))},e}();d.decorators=[{type:t.Injectable}],d.ctorParameters=function(){return[{type:p},{type:l},{type:c.ConfigService},{type:a.Router}]};var g=function(){function e(e,t,r,i){this.authStorage=e,this.errorHandler=t,this.configService=r,this.authenticatedResultService=i}return e.prototype.intercept=function(e,t){var i=this,o=e.url.toLowerCase();return this.configService.config&&this.configService.config.auth&&this.configService.config.auth.allowedUrls&&this.checkUrl(o,this.configService.config.auth.allowedUrls)?this.authenticatedResultService.authenticatedResult$.pipe(r.take(1),r.filter((function(e){return!!e})),r.mergeMap((function(){var r="Bearer "+i.authStorage.getItem("access_token"),o=e.headers.set("Authorization",r);return e=e.clone({headers:o}),t.handle(e)})),r.catchError((function(e){return i.errorHandler.handleError(e)}))):t.handle(e)},e.prototype.checkUrl=function(e,t){return!!t.find((function(t){return e.startsWith(t)}))},e}();g.decorators=[{type:t.Injectable}],g.ctorParameters=function(){return[{type:s.OAuthStorage},{type:s.OAuthResourceServerErrorHandler},{type:c.ConfigService},{type:l}]};var v=function(){function e(e,t){this.oauthService=e,this.windowRefService=t,this.location=this.windowRefService.nativeWindow.location}return e.prototype.handleError=function(e){return 401===e.status?(this.logout(!0),i.EMPTY):i.throwError(e)},e.prototype.logout=function(e){this.oauthService.redirectUri=this.calculateRedirectUri(e),this.oauthService.logOut()},e.prototype.calculateRedirectUri=function(e){var t=this.location,r=t.protocol,i=t.host,o=t.pathname,n=t.search;return r+"//"+i+(e?o+n:"")},e}();v.decorators=[{type:t.Injectable}],v.ctorParameters=function(){return[{type:s.OAuthService},{type:u.WindowRefService}]};var S=function(){function e(e,t){this.configService=e,this.windowRefService=t,this.prefix=this.configService.config.auth.clientId,this.storage=this.windowRefService.nativeWindow.sessionStorage}return e.prototype.getItem=function(e){return this.storage.getItem(this.calculateKey(e))},e.prototype.removeItem=function(e){this.storage.removeItem(this.calculateKey(e))},e.prototype.setItem=function(e,t){this.storage.setItem(this.calculateKey(e),t)},e.prototype.calculateKey=function(e){return this.prefix+"_"+e},e}();S.decorators=[{type:t.Injectable}],S.ctorParameters=function(){return[{type:c.ConfigService},{type:u.WindowRefService}]};var y=function(e,t,r,i){if(e)throw new Error("AuthenticationModule is already loaded. Import in your base AppModule only.");if(!t)throw new Error("You need to import the UtilServicesModule in your AppModule!");if(!r)throw new Error("You need to import the HttpClientModule in your AppModule!");if(!i)throw new Error("You need to import the AppConfigModule in your AppModule!")};y.decorators=[{type:t.NgModule,args:[{imports:[o.CommonModule,s.OAuthModule.forRoot()],declarations:[],providers:[p,l,f,d,{provide:n.HTTP_INTERCEPTORS,useClass:g,multi:!0},{provide:s.OAuthStorage,useClass:S},{provide:s.OAuthResourceServerErrorHandler,useClass:v}]}]}],y.ctorParameters=function(){return[{type:y,decorators:[{type:t.Optional},{type:t.SkipSelf}]},{type:u.WindowRefService,decorators:[{type:t.Optional}]},{type:n.HttpClientModule,decorators:[{type:t.Optional}]},{type:c.ConfigService,decorators:[{type:t.Optional}]}]},e.AuthenticatedGuard=f,e.AuthenticatedResultService=l,e.AuthenticationModule=y,e.AuthenticationService=p,e.CustomOAuthInterceptor=g,e.GuestGuard=d,e.ResourceServerAutoLogoutErrorHandler=v,e.SessionStorageOAuthStore=S,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=sofico-framework-authentication.umd.min.js.map