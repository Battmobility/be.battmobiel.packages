{"version":3,"file":"sofico-framework-ui-kit-components-stacked-bar-chart.js","sources":["../../../../projects/sofico-framework/ui-kit/components/stacked-bar-chart/stacked-bar-chart.component.ts","../../../../projects/sofico-framework/ui-kit/components/stacked-bar-chart/stacked-bar-chart.module.ts","../../../../projects/sofico-framework/ui-kit/components/stacked-bar-chart/sofico-framework-ui-kit-components-stacked-bar-chart.ts"],"sourcesContent":["import {\n  AfterViewInit,\n  ChangeDetectorRef,\n  Component,\n  ElementRef,\n  Input,\n  OnChanges,\n  OnDestroy,\n  OnInit,\n  ViewChild\n} from '@angular/core';\nimport {\n  ChartIdentifierConfig,\n  MultiValueChartValue\n} from '@sofico-framework/ui-kit/types';\nimport * as Chart from 'chart.js';\nimport { flatten } from 'lodash';\nimport { Changes, takeUntilDestroy, UntilDestroy } from 'ngx-reactivetoolkit';\nimport { combineLatest } from 'rxjs';\n\n@UntilDestroy()\n@Component({\n  selector: 'sof-stacked-bar-chart',\n  template: `\n    <div class=\"chart-container\" style=\"position: relative; width:100%\">\n      <canvas #chart></canvas>\n    </div>\n  `,\n  styleUrls: ['./stacked-bar-chart.component.scss']\n})\nexport class StackedBarChartComponent\n  implements OnDestroy, AfterViewInit, OnChanges, OnInit {\n  @ViewChild('chart', { static: true })\n  chartElem: ElementRef<HTMLCanvasElement>;\n\n  private chart: Chart;\n  private barChartData: any;\n  @Input() identifiersConfig: ChartIdentifierConfig[];\n  @Input() tooltipFn: (\n    xLabel: string | number,\n    itemLabel: string,\n    yValue: number,\n    identifier?: string,\n    percentage?: number\n  ) => string;\n  @Input() chartData: MultiValueChartValue[];\n  @Changes('identifiersConfig') identifiersConfig$;\n  @Changes('chartData') chartData$;\n\n  constructor(private cdRef: ChangeDetectorRef) {\n    this.cdRef.detach();\n  }\n\n  ngOnInit(): void {\n    combineLatest([this.identifiersConfig$, this.chartData$])\n      .pipe(takeUntilDestroy(this))\n      .subscribe(([identifiersConfig, values]) => {\n        this.setData(\n          identifiersConfig as ChartIdentifierConfig[],\n          values as MultiValueChartValue[]\n        );\n      });\n  }\n\n  ngOnChanges(): void {}\n\n  ngOnDestroy(): void {\n    this?.chart?.destroy();\n  }\n\n  ngAfterViewInit(): void {\n    const ctx = this.chartElem.nativeElement.getContext('2d');\n    this.chart = new Chart(ctx, {\n      type: 'bar',\n      data: this.barChartData,\n      options: {\n        tooltips: {\n          callbacks: {\n            label: (tooltipItem: any, data) => {\n              if (this.tooltipFn) {\n                const cur = data.datasets[tooltipItem.datasetIndex].data[\n                  tooltipItem.index\n                ] as number;\n                const total = data.datasets\n                  .map(v => (v?.data[tooltipItem.index] ?? 0) as number)\n                  .reduce((a, b) => a + b);\n                const percentage = (cur / total) * 100;\n                const stackItemLabel =\n                  data.datasets[tooltipItem.datasetIndex].label || '';\n                return this.tooltipFn(\n                  tooltipItem.xLabel,\n                  stackItemLabel,\n                  tooltipItem.value,\n                  (data.datasets[tooltipItem.datasetIndex] as any).identifier,\n                  Math.round(percentage * 100) / 100\n                );\n              }\n            }\n          }\n        },\n        aspectRatio: 1,\n        responsive: true,\n        legend: {\n          align: 'start',\n          rtl: true\n        } as any,\n        scales: {\n          xAxes: [\n            {\n              stacked: true\n            }\n          ],\n          yAxes: [\n            {\n              stacked: true\n            }\n          ]\n        }\n      }\n    });\n  }\n\n  private setData(\n    identifiersConfig: ChartIdentifierConfig[],\n    values: MultiValueChartValue[]\n  ): void {\n    if (!values || !identifiersConfig) {\n      return;\n    }\n    const labels = values.map(v => v?.xLabel);\n    const identifiers = [\n      ...new Set(\n        flatten(values.map(v => v.yValues.map(yValue => yValue.identifier)))\n      )\n    ];\n    const datasets = identifiers.map(identifier => {\n      const config = identifiersConfig.find(\n        item => item.identifier === identifier\n      );\n      return {\n        label: config?.label,\n        identifier,\n        backgroundColor: config?.backgroundColor,\n        data: values.map(\n          value =>\n            value.yValues.find(yValue => yValue.identifier === identifier)\n              ?.value\n        )\n      };\n    });\n    this.barChartData = {\n      labels,\n      datasets\n    };\n    if (this.chart) {\n      this.chart.data = this.barChartData;\n      this.chart.update();\n    }\n  }\n}\n","import { CommonModule } from '@angular/common';\nimport { NgModule } from '@angular/core';\nimport { StackedBarChartComponent } from './stacked-bar-chart.component';\n\n@NgModule({\n  declarations: [StackedBarChartComponent],\n  exports: [StackedBarChartComponent],\n  imports: [CommonModule]\n})\nexport class StackedBarChartModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}